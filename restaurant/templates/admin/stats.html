{% extends "unfold/layouts/base.html" %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="p-6 bg-gray-50  min-h-screen space-y-6">
    <div class="max-w-7xl mx-auto space-y-6">
        


        <div class="flex justify-between items-center bg-white  p-5 rounded-2xl shadow-sm border border-gray-100 " style="margin-bottom: 1rem !important;">
            <h2 class="text-2xl font-bold text-gray-800 ">Statistical Reports</h2>
            
            <form method="GET" class="flex items-center gap-3">
                <span class="text-sm font-medium text-gray-500  text-nowrap">View by:</span>
                <select name="period" onchange="this.form.submit()" 
                        class="bg-gray-50  border border-gray-200  text-gray-900  rounded-xl text-center" 
                        style="width: 7rem; height: 2.5rem;">
                    <option value="day" {% if period == 'day' %}selected{% endif %}>Days</option>
                    <option value="month" {% if period == 'month' %}selected{% endif %}>Months</option>
                    <option value="year" {% if period == 'year' %}selected{% endif %}>Years</option>
                </select>
            </form>
        </div>

        <div class="bg-white  rounded-2xl shadow-md border border-gray-100  overflow-hidden" style="margin-bottom: 1rem !important;">
            <div class="p-6 border-b border-gray-50  flex flex-col md:flex-row justify-between items-center gap-4">
                <h3 class="text-lg font-bold text-gray-800 ">Food Details</h3>
                <div class="relative" style="width: 800px;">
                    <input type="text" id="foodSearch" onkeyup="liveSearch()" 
                           placeholder="Find food..." 
                           class="w-full pl-4 pr-10 py-2.5 bg-gray-50  border-2 rounded-xl  text-sm ">
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left" id="mainTable">
                    <thead class="bg-gray-50/50  text-gray-500  uppercase text-xs font-bold">
                        <tr>
                            <th class="px-8 py-4">Names</th>
                            <th class="px-8 py-4 text-center">Quantities</th>
                            <th class="px-8 py-4 text-right">Revenues</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100 " id="tableBody">
                        {% for item in food_list %}
                        <tr class="hover:bg-orange-50/50  transition-colors">
                            <td class="px-8 py-4 font-semibold text-gray-800 ">{{ item.food__name }}</td>
                            <td class="px-8 py-4 text-center"><span class="px-3 py-1 bg-orange-100 text-orange-700  rounded-lg text-xs font-bold">{{ item.total_quantity }}</span></td>
                            <td class="px-8 py-4 text-right font-mono text-gray-600 ">{{ item.total_revenue|stringformat:"d" }} VNĐ</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="grid grid-cols-1 gap-6">
            <div class="bg-white  p-8 rounded-2xl shadow-md border border-gray-100 ">
                <h3 class="text-lg font-bold text-gray-80 uppercase tracking-wider">Top 5 Best-Selling Dishes</h3>
                <div class="h-px bg-orange-500 mt-2 w-20 mx-auto mb-6"></div>
                <div class="h-[400px]"><canvas id="foodChart"></canvas></div>
            </div>

            {% if is_admin %}

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6" style="margin-bottom: 1rem !important;">
                <div class="bg-white  p-5 rounded-2xl shadow-sm border border-gray-100  flex flex-col ">
                    <p class="text-xs font-bold text-gray-400 uppercase tracking-widest">Total Menu Items</p>
                    <p class="text-3xl font-bold text-orange-600 mt-1">{{ total_food_count }}</p>
                </div>

                <div class="bg-white  p-5 rounded-2xl shadow-sm border border-gray-100  flex flex-col ">
                    <p class="text-xs font-bold text-gray-400 uppercase tracking-widest">Total Reservations</p>
                    <p class="text-3xl font-bold text-orange-600 mt-1">{{ total_res }}</p>
                </div>
            </div>

            <div class="bg-white  p-8 rounded-2xl shadow-md border border-gray-100 ">
                <h3 class="text-lg font-bold text-gray-800 uppercase tracking-wider ">Overall Business Performance</h3>
                <div class="h-px bg-orange-500 mt-2 w-20 mx-auto mb-6"></div>
                <div class="h-[400px]"><canvas id="lineChart"></canvas></div>
            </div>

            <div class="bg-white p-8 rounded-2xl shadow-md border border-gray-100 ">
                <h3 class="text-lg font-bold text-gray-800  uppercase tracking-wider ">Reservation Frequency</h3>
                <div class="h-px bg-orange-500 mt-2 w-20 mx-auto mb-6"></div>
                <div class="h-[400px]"><canvas id="resChart"></canvas></div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    const rawData = {{ raw_data_json|safe }};
    const orangePrimary = '#f97316';
    const orangeFaded = 'rgba(249, 115, 22, 0.1)';
    const textColor = '#94a3b8';
    const gridColor = 'rgba(51, 65, 85, 0.5)';

    Chart.defaults.color = textColor;
    Chart.defaults.font.family = 'Inter, sans-serif';

    function liveSearch() {
        const query = document.getElementById('foodSearch').value.toLowerCase();
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';

        const results = rawData.filter(i => i.food__name.toLowerCase().includes(query)).slice(0, 10);

        if (results.length === 0) {
            tbody.innerHTML = `<tr><td colspan="3" class="px-8 py-20 text-center text-gray-400  italic">Food not found!!!</td></tr>`;
            return;
        }

        results.forEach(item => {
            tbody.innerHTML += `
                <tr class="hover:bg-orange-50/50  transition-colors"
                    <td class="px-8 py-4 font-semibold text-gray-800 ">${item.food__name}</td>
                    <td class="px-8 py-4 text-center"><span class="px-3 py-1 bg-orange-100 text-orange-700  rounded-lg text-xs font-bold">${item.total_quantity}</span></td>
                    <td class="px-8 py-4 text-right font-mono text-gray-600 ">${parseInt(item.total_revenue).toLocaleString()} VNĐ</td>
                </tr>`;
        });
    }

    new Chart(document.getElementById('foodChart'), {
        type: 'bar',
        data: {
            labels: {{ food_labels|safe }},
            datasets: [{
                label: 'Revenue (VNĐ)',
                data: {{ food_values|safe }},
                backgroundColor: orangePrimary,
                borderRadius: 12,
                barThickness: 32
            }]
        },
        options: {
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { grid: { color: gridColor }, border: { display: true }, beginAtZero: true },
                x: { grid: { display: false } ,border: { display: true }}
            }
        }
    });

    {% if is_admin %}

    new Chart(document.getElementById('lineChart'), {
        type: 'line',
        data: {
            labels: {{ line_labels|safe }},
            datasets: [{
                label: 'Total Revenues (VNĐ)',
                data: {{ line_values|safe }},
                borderColor: orangePrimary,
                backgroundColor: orangeFaded,
                fill: true,
                tension: 0.4,
                pointRadius: 6,
                pointBackgroundColor: '#fff',
                pointBorderWidth: 3
            }]
        },
        options: {
            maintainAspectRatio: false,
            scales: {
                y: { grid: { color: gridColor }, border: { display: true }, beginAtZero: true },
                x: { grid: { color: gridColor }, border: { display: true } }
            }
        }
    });


    new Chart(document.getElementById('resChart'), {
        type: 'bar',
        data: {
            labels: {{ res_labels|safe }},
            datasets: [{
                label: 'Bookings',
                data: {{ res_values|safe }},
                backgroundColor: '#3b82f6',
                borderRadius: 8,
                barThickness: 32
            }]
        },
        options: {
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, grid: { color: gridColor }, border: { display: true } },
                x: { grid: { display: false } , border: { display: true }}
            },
            plugins: { legend: { display: false } }
        }
    });
    {% endif %}
</script>
{% endblock %}