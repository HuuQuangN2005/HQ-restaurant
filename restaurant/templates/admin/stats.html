{% extends "unfold/layouts/base.html" %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="p-6 space-y-6 bg-gray-50 dark:bg-gray-900 transition-colors duration-300">
    
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-100 dark:border-gray-700 shadow-sm">
        <h2 class="text-xl font-bold text-gray-800 dark:text-white">Báo cáo hiệu quả kinh doanh</h2>
        <form method="GET" class="flex items-center gap-2">
            <label class="text-sm text-gray-500 dark:text-gray-400">Xem theo:</label>
            <select name="period" onchange="this.form.submit()" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-orange-500 focus:border-orange-500 block p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white">
                <option value="day" {% if period == 'day' %}selected{% endif %}>Ngày</option>
                <option value="month" {% if period == 'month' %}selected{% endif %}>Tháng</option>
                <option value="year" {% if period == 'year' %}selected{% endif %}>Năm</option>
            </select>
        </form>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden">
        <div class="p-6 border-b border-gray-50 dark:border-gray-700 flex flex-col md:flex-row md:items-center justify-between gap-4">
            <h3 class="font-bold text-gray-800 dark:text-gray-100">Danh sách doanh thu món ăn (Tối đa 10)</h3>
            <div class="relative w-full md:w-72">
                <input type="text" id="foodSearch" onkeyup="filterFood()" placeholder="Tìm món ăn..." 
                       class="block w-full pl-4 pr-10 py-2 border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-lg focus:ring-orange-500 text-sm">
            </div>
        </div>

        <div class="overflow-x-auto min-h-[200px]">
            <table class="w-full text-sm text-left" id="foodTable">
                <thead class="bg-gray-50 dark:bg-gray-700/50 text-gray-700 dark:text-gray-300 uppercase text-xs">
                    <tr>
                        <th class="px-6 py-4">Tên món</th>
                        <th class="px-6 py-4">Số lượng</th>
                        <th class="px-6 py-4 text-right">Doanh thu</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100 dark:divide-gray-700" id="foodBody">
                    {% for item in all_food_stats %}
                    <tr class="hover:bg-orange-50 dark:hover:bg-orange-900/10 transition-colors">
                        <td class="px-6 py-4 font-medium text-gray-900 dark:text-white">{{ item.food__name }}</td>
                        <td class="px-6 py-4 text-orange-600 dark:text-orange-400 font-bold">{{ item.total_qty }}</td>
                        <td class="px-6 py-4 text-right">{{ item.total_rev|stringformat:"d" }} VNĐ</td>
                    </tr>
                    {% empty %}
                    <tr id="noDataRow"><td colspan="3" class="px-6 py-10 text-center text-gray-400 italic">Không có dữ liệu</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700">
        <h3 class="font-bold mb-4 text-gray-800 dark:text-gray-100 uppercase text-sm tracking-widest">Top 5 món bán chạy nhất</h3>
        <div class="h-80"><canvas id="barChart"></canvas></div>
    </div>

    {% if is_admin %}
    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700">
        <h3 class="font-bold mb-4 text-gray-800 dark:text-gray-100 uppercase text-sm tracking-widest">Doanh số tổng hợp hệ thống</h3>
        <div class="h-80"><canvas id="lineChart"></canvas></div>
    </div>
    {% endif %}

</div>

<script>
    const fullData = {{ full_food_data_json|safe }};
    const orangeMain = 'rgba(249, 115, 22, 0.8)';
    const orangeBorder = 'rgba(249, 115, 22, 1)';

    // 1. Logic Tìm kiếm nâng cao
    function filterFood() {
        const input = document.getElementById('foodSearch').value.toLowerCase();
        const body = document.getElementById('foodBody');
        body.innerHTML = '';

        const filtered = fullData.filter(item => item.food__name.toLowerCase().includes(input)).slice(0, 10);

        if (filtered.length === 0) {
            body.innerHTML = `<tr><td colspan="3" class="px-6 py-10 text-center text-gray-400 italic bg-white dark:bg-gray-800">Không có dữ liệu tương ứng</td></tr>`;
            return;
        }

        filtered.forEach(item => {
            const row = `
                <tr class="hover:bg-orange-50 dark:hover:bg-orange-900/10 transition-colors border-b dark:border-gray-700 last:border-0">
                    <td class="px-6 py-4 font-medium text-gray-900 dark:text-white">${item.food__name}</td>
                    <td class="px-6 py-4 text-orange-600 dark:text-orange-400 font-bold">${item.total_qty}</td>
                    <td class="px-6 py-4 text-right">${parseInt(item.total_rev).toLocaleString()} VNĐ</td>
                </tr>`;
            body.innerHTML += row;
        });
    }

    // 2. Cấu hình Chart.js chung cho Dark Mode
    const getChartTheme = () => {
        const isDark = document.documentElement.classList.contains('dark');
        return {
            fontColor: isDark ? '#E5E7EB' : '#374151',
            gridColor: isDark ? 'rgba(75, 85, 99, 0.2)' : 'rgba(229, 231, 235, 0.5)'
        };
    };

    function renderCharts() {
        const theme = getChartTheme();

        // Bar Chart
        new Chart(document.getElementById('barChart'), {
            type: 'bar',
            data: {
                labels: {{ bar_labels|safe }},
                datasets: [{
                    label: 'Doanh thu',
                    data: {{ bar_values|safe }},
                    backgroundColor: orangeMain,
                    borderColor: orangeBorder,
                    borderWidth: 1,
                    borderRadius: 6
                }]
            },
            options: {
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, ticks: { color: theme.fontColor }, grid: { color: theme.gridColor } },
                    x: { ticks: { color: theme.fontColor }, grid: { display: false } }
                },
                plugins: { legend: { display: false } }
            }
        });

        // Line Chart (nếu có)
        const lineCtx = document.getElementById('lineChart');
        if (lineCtx) {
            new Chart(lineCtx, {
                type: 'line',
                data: {
                    labels: {{ line_labels|safe }},
                    datasets: [{
                        label: 'Doanh số',
                        data: {{ line_values|safe }},
                        borderColor: orangeBorder,
                        backgroundColor: 'rgba(249, 115, 22, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    scales: {
                        y: { ticks: { color: theme.fontColor }, grid: { color: theme.gridColor } },
                        x: { ticks: { color: theme.fontColor }, grid: { color: theme.gridColor } }
                    }
                }
            });
        }
    }

    // Khởi tạo và theo dõi đổi theme
    document.addEventListener('DOMContentLoaded', renderCharts);
    const observer = new MutationObserver(() => {
        // Xóa biểu đồ cũ để vẽ lại đúng màu font khi đổi theme
        location.reload(); 
    });
    observer.observe(document.documentElement, { attributes: true, attributeFilter: ['class'] });
</script>
{% endblock %}